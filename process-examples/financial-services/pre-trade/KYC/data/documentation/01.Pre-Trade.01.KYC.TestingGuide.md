# KYC Workflow Testing Guide

## Overview

This guide explains how to use the example data and schemas provided for testing the Client Onboarding & KYC workflow. It is designed for developers, testers, and business analysts who need to understand how data flows through the process.

## Prerequisites

- Understanding of BPMN 2.0 notation
- Familiarity with JSON and JSON Schema
- Access to Camunda 7 / Fluxnova workflow engine
- Basic understanding of KYC/AML compliance processes

## Directory Structure

```
data/
├── schemas/              # JSON schemas for validation
│   ├── process/         # Process input schemas
│   ├── tasks/           # Task input/output schemas
│   └── gateways/        # Gateway test case schemas
├── examples/            # Example data files
│   ├── process-inputs/  # Process start data
│   ├── task-outputs/    # Individual task outputs
│   └── end-to-end/      # Complete workflow examples
├── reference/           # Reference data
│   ├── Countries.json
│   ├── DocumentTypes.json
│   ├── RiskFactors.json
│   └── SanctionsLists.json
└── documentation/       # Documentation files
    ├── DataDictionary.md
    ├── TestingGuide.md (this file)
    └── DMN.RiskAssessment.DecisionTable.md
```

## Quick Start

### 1. Validate a Process Input

To validate that your process input data is correct:

```bash
# Using a JSON schema validator
ajv validate -s schemas/process/01.Pre-Trade.01.KYC.ProcessInput.Schema.json \
             -d examples/process-inputs/01.Pre-Trade.01.KYC.ProcessInput.Example-Individual.json
```

### 2. Start a Process Instance

Use the example process input to start a new workflow instance:

```javascript
// Using Camunda REST API
const processInput = require('./examples/process-inputs/01.Pre-Trade.01.KYC.ProcessInput.Example-Individual.json');

fetch('http://localhost:8080/engine-rest/process-definition/key/Process_ClientOnboardingKYC/start', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    variables: {
      applicationId: { value: processInput.applicationId, type: 'String' },
      clientType: { value: processInput.clientType, type: 'String' },
      applicantDetails: { value: JSON.stringify(processInput.applicantDetails), type: 'Json' },
      // ... other variables
    }
  })
});
```

### 3. Test Individual Tasks

Each task has example outputs you can use for testing:

```javascript
// Complete a document verification task with example output
const verificationOutput = require('./examples/task-outputs/verify-documents/01.Pre-Trade.01.KYC.Task.VerifyDocuments.Output.Example-Verified.json');

// Set the process variables based on the output
camunda.completeTask(taskId, {
  variables: {
    documentsVerified: { value: verificationOutput.documentsVerified, type: 'Boolean' },
    overallConfidenceScore: { value: verificationOutput.overallConfidenceScore, type: 'Double' },
    // ... other variables
  }
});
```

## Test Scenarios

### Scenario 1: Low-Risk Individual (Happy Path)

**Objective:** Test the complete workflow for a low-risk individual client who is auto-approved.

**Input File:** `examples/process-inputs/01.Pre-Trade.01.KYC.ProcessInput.Example-Individual.json`

**Expected Path:**

1. Application Submitted
2. Capture Client Data
3. Upload Documents
4. Verify Documents (Pass)
5. Sanctions Screening (No Match)
6. Risk Assessment (Low Risk)
7. Account Opening (Auto-Approved)
8. Notify Client
9. Onboarding Complete

**Key Assertions:**

- `documentsVerified` = `true`
- `sanctionsMatch` = `false`
- `riskCategory` = `Low`
- `autoApprovalEligible` = `true`
- Process completes in <1000 seconds
- No manual review tasks created

**Complete Example:** `examples/end-to-end/01.Pre-Trade.01.KYC.E2E.Example-LowRisk-AutoApproved.json`

### Scenario 2: Medium-Risk Corporate (Manual Review)

**Objective:** Test workflow for a medium-risk corporate client requiring compliance review.

**Input File:** `examples/process-inputs/01.Pre-Trade.01.KYC.ProcessInput.Example-Corporate.json`

**Expected Path:**
1-6. (Same as Scenario 1)
7. Risk Assessment (Medium Risk)
8. Compliance Review Task Created
9. Compliance Officer Reviews (Approve)
10. Account Opening
11. Notify Client
12. Onboarding Complete

**Key Assertions:**

- `riskCategory` = `Medium`
- `autoApprovalEligible` = `false`
- `approvalAuthority` = `compliance-officer`
- Compliance review task created
- Process does not complete until manual approval

**Complete Example:** `examples/end-to-end/01.Pre-Trade.01.KYC.E2E.Example-MediumRisk-ManualApproval.json`

### Scenario 3: High-Risk PEP (Enhanced Due Diligence)

**Objective:** Test workflow for high-risk client with PEP connections requiring EDD.

**Input File:** `examples/process-inputs/01.Pre-Trade.01.KYC.ProcessInput.Example-HighRisk.json`

**Expected Path:**
1-6. (Same as Scenario 1)
7. Risk Assessment (High Risk)
8. Enhanced Due Diligence Task Created
9. Senior Compliance Reviews
10. Compliance Decision Gateway (Approve)
11. Account Opening
12. Notify Client
13. Onboarding Complete

**Key Assertions:**

- `riskCategory` = `High`
- `isPEP` = `true`
- `approvalAuthority` = `mlro`
- Enhanced due diligence task created
- MLRO approval required

**Complete Example:** `examples/end-to-end/01.Pre-Trade.01.KYC.E2E.Example-HighRisk-EDD.json`

### Scenario 4: Sanctions Hit (Rejection)

**Objective:** Test workflow when beneficial owner is on sanctions list.

**Input File:** Create custom input with sanctioned individual

**Expected Path:**
1-5. (Same as Scenario 1)
6. Sanctions Screening (Match Found)
7. Compliance Investigation Task Created
8. Compliance Investigation (Sanctions Not Cleared)
9. Application Rejected
10. End

**Key Assertions:**

- `sanctionsMatch` = `true`
- `sanctionsCleared` = `false`
- Compliance investigation task created
- Application rejected
- SAR filed
- Client notified of rejection

**Complete Example:** `examples/end-to-end/01.Pre-Trade.01.KYC.E2E.Example-SanctionsHit-Rejected.json`

### Scenario 5: Document Verification Failure (Remediation)

**Objective:** Test workflow when documents fail verification and require remediation.

**Input File:** `examples/process-inputs/01.Pre-Trade.01.KYC.ProcessInput.Example-Individual.json`

**Task Output Override:** Use `examples/task-outputs/verify-documents/01.Pre-Trade.01.KYC.Task.VerifyDocuments.Output.Example-Failed.json`

**Expected Path:**
1-4. (Same as Scenario 1)
5. Verify Documents (Fail)
6. Ops Remediation Task Created
7. Ops Team Corrects/Requests New Documents
8. Re-attempt Verification (Pass)
9. Continue with Sanctions Screening
10. (Complete as Scenario 1)

**Key Assertions:**

- Initial `documentsVerified` = `false`
- Ops remediation task created
- After remediation, `documentsVerified` = `true`
- Process continues successfully

**Complete Example:** `examples/end-to-end/01.Pre-Trade.01.KYC.E2E.Example-DocumentFailure-Remediation.json`

### Scenario 6: SLA Breach (Escalation)

**Objective:** Test SLA monitoring and escalation mechanisms.

**Setup:** Delay task completion beyond SLA thresholds

**Expected Behaviour:**

- Document verification >48 hours → Ops Manager escalation
- Risk assessment >24 hours → Compliance Manager escalation
- Process >120 hours → Senior Management escalation + audit marking

**Key Assertions:**

- Escalation service tasks triggered
- SLA breach logged
- Appropriate personnel notified
- Audit case marked

**Complete Example:** `examples/end-to-end/01.Pre-Trade.01.KYC.E2E.Example-SLA-Breach.json`

## Gateway Testing

### Testing Gateway Decisions

Each gateway decision can be tested independently using the test case files:

```javascript
// Example: Testing Documents Verified Gateway
const testCases = require('./examples/end-to-end/01.Pre-Trade.01.KYC.Gateway.DocumentsVerified.TestCases.json');

testCases.forEach(testCase => {
  const result = evaluateGateway(testCase.processVariables);
  assert.equal(result.pathTaken, testCase.expectedPath);
});
```

### Gateway Test Case Structure

Each gateway test case file contains multiple scenarios:

```json
{
  "gatewayId": "Gateway_DocumentsVerified",
  "testCases": [
    {
      "testCaseId": "DV-001",
      "description": "Documents verified successfully",
      "processVariables": {
        "documentsVerified": true
      },
      "expectedPath": "Yes",
      "expectedTarget": "ServiceTask_SanctionsPEP"
    },
    {
      "testCaseId": "DV-002",
      "description": "Documents failed verification",
      "processVariables": {
        "documentsVerified": false
      },
      "expectedPath": "No",
      "expectedTarget": "UserTask_OpsRemediation"
    }
  ]
}
```

## Mock Services

### Document Verification Service

For testing without external IDV providers:

```javascript
// Mock Onfido response
function mockDocumentVerification(documents) {
  return {
    taskId: generateTaskId('VERIFY'),
    completedTimestamp: new Date().toISOString(),
    documentsVerified: Math.random() > 0.2, // 80% pass rate
    overallConfidenceScore: 85 + Math.random() * 15,
    // ... other fields
  };
}
```

### Sanctions Screening Service

Mock sanctions screening to test different outcomes:

```javascript
function mockSanctionsScreening(entities, sanctionsHitProbability = 0.05) {
  const sanctionsMatch = Math.random() < sanctionsHitProbability;
  const isPEP = Math.random() < 0.10;
  
  return {
    taskId: generateTaskId('SANC'),
    completedTimestamp: new Date().toISOString(),
    sanctionsMatch,
    isPEP,
    // ... other fields
  };
}
```

### Risk Assessment DMN

Test the DMN decision table with various inputs:

```javascript
function testRiskAssessment() {
  const inputs = [
    { clientType: 'individual', jurisdiction: 'GBR', isPEP: false, volume: 150000 },
    { clientType: 'corporate', jurisdiction: 'ARE', isPEP: true, volume: 75000000 },
    // ... more test cases
  ];
  
  inputs.forEach(input => {
    const result = evaluateDMN('RiskAssessment', input);
    console.log(`Input: ${JSON.stringify(input)} → Risk: ${result.riskCategory}`);
  });
}
```

## Data Generation

### Generating Test Data

Use the provided schemas to generate valid test data:

```javascript
const Faker = require('faker');
const { validate } = require('jsonschema');

function generateIndividualApplication() {
  const application = {
    applicationId: `APP-${formatDate(new Date())}-${randomString(6)}`,
    submissionTimestamp: new Date().toISOString(),
    clientType: 'individual',
    applicantDetails: {
      title: Faker.name.prefix(),
      firstName: Faker.name.firstName(),
      lastName: Faker.name.lastName(),
      dateOfBirth: Faker.date.past(50, new Date(2005, 0, 1)).toISOString().split('T')[0],
      nationality: 'GBR',
      // ... other fields
    },
    // ... other fields
  };
  
  // Validate against schema
  const schema = require('./schemas/process/01.Pre-Trade.01.KYC.ProcessInput.Schema.json');
  const validation = validate(application, schema);
  
  if (!validation.valid) {
    throw new Error(`Invalid application data: ${JSON.stringify(validation.errors)}`);
  }
  
  return application;
}
```

### Bulk Test Data Creation

Generate multiple test applications for load testing:

```bash
# Generate 100 test applications
node scripts/generate-test-data.js --count 100 --output test-data/

# Generate specific risk profiles
node scripts/generate-test-data.js --risk low --count 50
node scripts/generate-test-data.js --risk high --count 10 --pep true
```

## Performance Testing

### Load Testing Scenarios

1. **Steady State:** 10 applications/hour for 8 hours
2. **Peak Load:** 50 applications/hour for 2 hours
3. **Stress Test:** 100 applications/hour until system degrades

### Metrics to Monitor

- Process instance completion time
- Task completion time
- SLA compliance rate
- Gateway decision accuracy
- Service task success rate
- Database query performance

### Expected Performance Baselines

| Metric | Target | Acceptable | Poor |
|--------|--------|------------|------|
| Low-risk auto-approval | <2 min | <5 min | >5 min |
| Document verification | <3 min | <10 min | >10 min |
| Sanctions screening | <30 sec | <2 min | >2 min |
| Risk assessment (DMN) | <1 sec | <5 sec | >5 sec |
| Overall process (low-risk) | <15 min | <1 hour | >1 hour |

## Troubleshooting

### Common Issues

#### Issue: Process Variables Not Set Correctly

**Symptoms:** Gateway takes wrong path, process stalls

**Solution:**

1. Check variable names match exactly (case-sensitive)
2. Verify variable types (Boolean vs String "true")
3. Use process instance variables view in Cockpit

#### Issue: Schema Validation Failures

**Symptoms:** Application rejected at process start

**Solution:**

1. Validate JSON syntax
2. Check required fields are present
3. Verify data types match schema
4. Use schema validator tool

#### Issue: DMN Decision Returns Unexpected Result

**Symptoms:** Risk category doesn't match expectations

**Solution:**

1. Review DMN decision table logic
2. Check input variable values
3. Verify DMN rule priorities
4. Test with DMN simulator

#### Issue: SLA Timers Not Triggering

**Symptoms:** Escalation tasks not created

**Solution:**

1. Verify timer expressions are correct (PT48H format)
2. Check job executor is running
3. Review timer configuration in BPMN
4. Check system time synchronisation

## Best Practices

### 1. Always Validate Against Schemas

Before starting a process or completing a task, validate your data against the appropriate schema.

### 2. Use Meaningful Test Data

Use realistic names, addresses, and values rather than "test test" or "123 Test Street".

### 3. Test All Paths

Ensure you test every gateway decision path, not just the happy path.

### 4. Monitor SLAs

Always check that SLA timers are working correctly in your test environment.

### 5. Document Test Results

Keep records of test executions, especially for regulatory-critical paths like sanctions screening.

### 6. Use Version Control

Store test data and configurations in version control alongside the BPMN definitions.

### 7. Automate Regression Tests

Create automated test suites for common scenarios to catch regressions quickly.

## Continuous Integration

### CI/CD Pipeline Integration

```yaml
# Example GitHub Actions workflow
name: KYC Workflow Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Validate Schemas
        run: |
          npm install -g ajv-cli
          ajv compile -s data/schemas/**/*.json
      
      - name: Start Camunda
        run: docker-compose up -d camunda
      
      - name: Deploy Process
        run: |
          npm install
          npm run deploy
      
      - name: Run E2E Tests
        run: npm run test:e2e
      
      - name: Generate Test Report
        run: npm run report
```

## Additional Resources

- [BPMN 2.0 Specification](https://www.omg.org/spec/BPMN/2.0/)
- [Camunda Documentation](https://docs.camunda.org/)
- [DMN Specification](https://www.omg.org/spec/DMN/)
- [JSON Schema Documentation](https://json-schema.org/)
- Data Dictionary: [01.Pre-Trade.01.KYC.DataDictionary.md](./01.Pre-Trade.01.KYC.DataDictionary.md)
- Process Definition: [01.Pre-Trade.01.KYC.BusinessProcessDefinition.md](../../01.Pre-Trade.01.KYC.BusinessProcessDefinition.md)

## Support

For questions or issues with the test data:

1. Check this testing guide
2. Review the Data Dictionary
3. Examine the complete E2E examples
4. Raise an issue in the repository

---

**Document Version:** 1.0  
**Last Updated:** 8 January 2025  
**Author:** KYC Team
